<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="web-socket.html">
<link rel="import" href="shared-styles.html">

<dom-module id="page-spyfall">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
            }
            paper-tabs {
                color: white;
                background-color: var(--app-primary-color);
            }
        </style>

        <div class="card">
            <h2>Spyfall</h2>
            <p>
                Join Code: <span>{{state.Code}}</span>
            </p>
            <template is="dom-if" if="{{!state.Started}}">
                <p>
                    Waiting for all players to be ready. Press
                    <iron-icon icon="thumb-up"></iron-icon>
                    to ready up.
                </p>
                <p>
                    When the game starts, one player will randomly
                    be chosen as the Spy. All players will see a location
                    except for the Spy. To find the Spy, players take turns
                    asking one question to another player until time runs out.
                    The player with the <iron-icon icon="star"></iron-icon>
                    goes first.
                </p>
            </template>
            <div hidden$="{{!state.Started}}">
                <p>{{time}}</p>
                <div hidden$="{{!you.Spy}}">
                    <p>
                        You are the Spy! Try to figure out what everyone else's
                        location is. Once you know it, shout it out before the timer
                        runs out, and you win. If the timer runs out and everyone
                        else doesn't guess you are the Spy, then you win.
                    </p>
                </div>
                <div hidden$="{{you.Spy}}">
                    <p>
                        You are <b>not</b> the Spy! To find the Spy, the player
                        with the <iron-icon icon="star"></iron-icon> next to their name
                        asks one person a question relating to your shared location.
                        The person must answer, trying not to give away the location
                        to the Spy, and then proceeds to ask another person a question.
                    </p>
                    <p>
                        If everyone agrees on who the spy is before the time runs out,
                        then the Spy loses. If the Spy reveals themselves and correctly
                        guesses the location, then the Spy wins.
                    </p>
                    <p>Location: {{you.Location}}</p>
                    <p>Role: {{you.Role}}</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Players</h2>
            <ul>
            <template is="dom-repeat" items="{{state.Players}}">
                <li>
                    <span hidden$="{{!item.First}}">
                        <iron-icon icon="star"></iron-icon>
                    </span>
                    {{name(item)}}
                    <span hidden$="{{item.Connected}}">
                        <iron-icon icon="warning"></iron-icon>
                    </span>
                    <span hidden$="{{state.Started}}">
                        <span hidden$="{{!item.Ready}}">
                            <iron-icon icon="thumb-up"></iron-icon>
                        </span>
                        <span hidden$="{{item.Ready}}">
                            <iron-icon icon="thumb-down"></iron-icon>
                        </span>
                    </span>
                </li>
            </template>
            </ul>
        </div>

        <div hidden$="{{state.Started}}">
            <div hidden$="{{you.Ready}}">
                <paper-fab icon="thumb-up" on-tap="readyup"></paper-fab>
            </div>
            <div hidden$="{{!you.Ready}}">
                <paper-fab icon="thumb-down" on-tap="readyup"></paper-fab>
            </div>
        </div>
        <div hidden$="{{!state.Started}}">
            <paper-fab icon="av:stop" on-tap="stop"></paper-fab>
        </div>

        <div class="card">
            <h2>Locations</h2>
            <ul>
                <template is="dom-repeat" items="{{_keys(locations)}}">
                    <li>
                        {{item}}
                    </li>
                </template>
            </ul>
        </div>

        <web-socket id="ws" url="ws://localhost:2015/api/spyfall" ws="{{ws}}"></web-socket>

        <iron-ajax
            auto
            url="/api/spyfall/locations"
            handle-as="json"
            last-response="{{locations}}"></iron-ajax>

        <paper-toast id="lost" text="Can't connect to server" horizontal-align="right">
            <a href="" on-tap="connect">Retry</a>
        </paper-toast>
        <paper-toast id="errors" text="" horizontal-align="right">
        </paper-toast>
        <paper-toast id="messages" text="" duration="3000" horizontal-align="right">
        </paper-toast>
    </template>

    <script>
        Polymer({
            is: 'page-spyfall',
            properties: {
                route: {
                    type: Object,
                    notify: true
                },
                tab: {
                    type: Number,
                    value: 0
                },
                player: {
                    type: Object,
                    observer: '_playerChanged'
                },
                connecting: {
                    type: Boolean,
                    value: false
                },
                inGame: {
                    type: Boolean,
                    value: false
                }
            },
            listeners: {
                onopen: 'onOpen',
                onclose: 'onClose',
                onmessage: 'onMessage'
            },
            _neq: function (a, b) {
                return a !== b;
            },
            ready: function () {
                if (this.player != null && !this.connecting && this.ws == null) {
                    this.connect();
                } else {
                    console.log("Player isn't fetched yet, waiting to connect");
                }
            },
            detached: function () {

            },
            start: function() {
                console.log("Start");
                this.ready();
            },
            _playerChanged: function(newPlayer, oldPlayer) {
                console.log("Player changing to", newPlayer);
                if (newPlayer != null && !this.inGame && this.ws == null && !this.connecting) {
                    console.log("Connecting");
                    this.connect();
                }
            },
            connect: function () {
                this.connecting = true;
                this.$.lost.text = "Connecting...";
                this.$.ws.connect();
            },
            onOpen: function () {
                this.connecting = false;
                this.$.lost.close();

                if (!this.inGame) {
                    if (this.route.path === '/spyfall') {
                        this.ws.send(JSON.stringify({Type: "NEW", Cmd: {Msg: 'spyfall'}}));
                    } else {
                        this.ws.send(JSON.stringify({Type: "JOIN", Cmd: {Msg: this.route.path.split('/').slice(-1)[0]}}))
                    }
                }
            },
            onError: function (e) {
                console.log("ERROR", e.detail);
            },
            onClose: function (e) {
                console.log(e.detail);
                this.connecting = false;
                this.$.lost.text = "Can't connect to server";
                this.$.lost.duration = 0;
                this.$.lost.open();
            },
            onMessage: function (e) {
                this.inGame = true;
                var msg = e.detail;
                switch (msg.Type) {
                    case 'cookie':
                        console.log("Setting cookie", msg.Cookie);
                        document.cookie = msg.Cookie;
                        break;
                    case 'spyfall':
                        this.state = msg.Spyfall;
                        this.you = msg.You;
                        this.set('route.path', '/spyfall/'+this.state.Id);
                        break;
                    case 'error':
                        console.log(msg.Msg);
                        this.$.errors.text = msg.Msg;
                        this.$.errors.open();
                        break;
                    case 'starting':
                        this.$.messages.text = msg.Msg;
                        this.$.messages.open();
                        break;
                    case 'tick':
                        this.time = msg.Msg;
                        break;
                    default:
                        console.log("GOT MSG:", msg);
                }
            },
            name: function (player) {
                return player.Name ? player.Name : "Guest " + player.ID.slice(-5);
            },
            _keys: function(obj) {
                return Object.keys(obj);
            },
            readyup: function() {
                this.ws.send(JSON.stringify({Type: "READY"}))
            },
            stop: function() {
                this.ws.send(JSON.stringify({Type: "STOP"}))
            }
        });
    </script>
</dom-module>
